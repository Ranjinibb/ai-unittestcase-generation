name: Build & Deploy via Lambda Agent

on:
  push:
    branches: [ "main" ]

jobs:
  build-trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Build (pipelineStart Lambda)
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.AGENT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"commit\": \"${{ github.sha }}\"}" \
            ${{ secrets.AGENT_URL_PIPELINE }}

  deploy:
    needs: build-trigger
    runs-on: ubuntu-latest
    environment: production  # <-- human approval here
    steps:
      - name: Deploy via Lambda (deployToECS)
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.AGENT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"commit\": \"${{ github.sha }}\"}" \
            ${{ secrets.AGENT_URL_DEPLOY }}