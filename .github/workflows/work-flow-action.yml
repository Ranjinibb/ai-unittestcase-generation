name: AI Unit Tests (Java - Lambda)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  generate-and-validate-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Maven folder to satisfy cache
        run: mkdir -p ~/.m2/repository

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::595868460191:role/bedrock_aws
          aws-region: us-east-1
      # OIDC approach (no long-lived keys) is the recommended pattern. [1](https://docs.github.com/en/actions/how-tos/secure-your-work/security-harden-deployments/oidc-in-aws)

      - name: Compute changed Java files
        id: changed
        shell: bash
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep '^src/main/java/.*\.java$' || true)
          {
            echo "changed<<EOF"
            echo "$CHANGED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          printf "%s\n" "$CHANGED" > changed_files.txt
          echo "[DEBUG] Changed sources:"; cat changed_files.txt

      - name: Prepare payload for Lambda
        if: steps.changed.outputs.changed != ''
        shell: bash
        run: |
          python3 - << 'PY'
          import json, pathlib, os
          changed = pathlib.Path("changed_files.txt").read_text().strip().splitlines()
          files=[]
          for p in changed:
            try:
              files.append({"path": p, "content": pathlib.Path(p).read_text(encoding="utf-8")})
            except Exception:
              pass
          payload = {"repo": os.getenv("GITHUB_REPOSITORY"),
                     "prNumber": int(os.getenv("PR_NUMBER") or 0),
                     "files": files}
          pathlib.Path("payload.json").write_text(json.dumps(payload))
          PY
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Invoke Lambda (generate tests)
        if: steps.changed.outputs.changed != ''
        shell: bash
        run: |
          set -e
          # Call synchronously and capture response to out.json
          aws lambda invoke \
            --function-name ai-test-generator \
            --cli-binary-format raw-in-base64-out \
            --payload file://payload.json \
            out.json >/dev/null
          cat out.json | jq -r '.zip_base64' > zip.b64
          if [ -s zip.b64 ] && [ "$(wc -c < zip.b64)" -gt 2 ]; then
            base64 -d zip.b64 > generated_tests.zip
            echo "has_zip=yes" >> $GITHUB_OUTPUT
          else
            echo "has_zip=no" >> $GITHUB_OUTPUT
          fi
      # Using aws lambda invoke is the standard & documented synchronous call. [3](https://docs.aws.amazon.com/cli/latest/reference/lambda/invoke.html)[10](https://bobbyhadz.com/blog/aws-cli-invoke-lambda-functions)
        id: inv

      - name: Unpack tests (if any)
        if: steps.inv.outputs.has_zip == 'yes'
        shell: bash
        run: |
          rm -rf gen_out && mkdir -p gen_out src/java/test
          unzip -o generated_tests.zip -d gen_out >/dev/null
          # Copy everything under src/java/test from the zip into the workspace
          if [ -d gen_out/src/java/test ]; then
            rsync -a gen_out/src/java/test/ src/java/test/
          fi
          echo "[DEBUG] src/java/test tree:"; ls -R src/java/test || true

      - name: Copy generated tests ‚Üí Maven folder
        if: steps.inv.outputs.has_zip == 'yes'
        shell: bash
        run: |
          mkdir -p src/test/java
          find src/java/test -type f -name '*.java' -print -exec bash -c '
            rel="${1#src/java/test/}"
            dest="src/test/java/$rel"
            mkdir -p "$(dirname "$dest")"
            cp "$1" "$dest"
          ' _ {} \;

      - name: Detect generated tests
        id: tests
        shell: bash
        run: |
          git add -N src/test/java || true
          if git diff --name-only --exit-code src/test/java; then
            echo "has_tests=no" >> "$GITHUB_OUTPUT"
            echo "[DEBUG] No new tests."
          else
            echo "has_tests=yes" >> "$GITHUB_OUTPUT"
            echo "[DEBUG] New/updated tests:"; git diff --name-only src/test/java
          fi

      - name: Run unit tests
        if: steps.tests.outputs.has_tests == 'yes'
        run: mvn -B test

      - name: Create Bot PR with generated tests
        if: steps.tests.outputs.has_tests == 'yes'
        id: cpr
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "test(ai): add generated unit tests"
          title: "AI: Generated unit tests for PR #${{ github.event.pull_request.number }}"
          body: |
            This PR adds **AI-generated unit tests** for Java files changed in PR #${{ github.event.pull_request.number }}.
            - Generated by AWS Lambda (Bedrock)
            - Validated with Maven
          branch: ai/tests/pr-${{ github.event.pull_request.number }}
          add-paths: |
            src/test/java/**
          delete-branch: true

      - name: Comment result on original PR (PR created)
        if: steps.tests.outputs.has_tests == 'yes' && steps.cpr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request.number;
            const url = '${{ steps.cpr.outputs.pull-request-url }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body: `‚úÖ AI-generated unit tests created.\nüîó Bot PR: ${url}`
            });

      - name: Comment no-op on PR (no tests)
        if: steps.tests.outputs.has_tests != 'yes'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body: `‚ÑπÔ∏è No AI tests generated for this PR (no eligible changes or no output).`
            });
